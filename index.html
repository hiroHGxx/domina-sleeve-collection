
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domina Games Sleeve Collection</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .product-image {
            max-width: 100px;
            height: auto;
            border-radius: 8px;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .container-fluid {
            padding-left: 2rem;
            padding-right: 2rem;
        }
        .card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-owned-toggle {
            width: 100px;
        }
        .filter-controls {
            margin-bottom: 1.5rem;
        }
        .price-input {
            min-width: 80px; /* Shortened width */
            text-align: right;
        }
        .price-input.has-value {
            background-color: #fff3cd;
            border-color: #ffc107;
            font-weight: 500;
        }
        .price-input.lowest-price {
            background-color: #d1e7dd;
            border-color: #198754;
            font-weight: 700;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
        .price-cell-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <header class="text-center my-5">
            <h1 class="display-4">Domina Games Sleeve Collection</h1>
            <p class="lead text-muted">A comprehensive list of card sleeves.</p>
        </header>

        <main>
            <!-- Filter Controls -->
            <div class="filter-controls text-center">
                <div class="btn-group" role="group" aria-label="Filter by ownership">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">All</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="owned">Owned</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="not-owned">Not Owned</button>
                </div>
            </div>

            <!-- Data Management Controls -->
            <div class="text-center mb-3">
                <div class="btn-group" role="group" aria-label="Data management">
                    <button type="button" class="btn btn-outline-success" id="export-data-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export Data
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="import-data-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                        Import Data
                    </button>
                </div>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>

            <div class="card">
                <div class="card-body table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Image</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">Owned</th>
                                <th scope="col">Mercari</th>
                                <th scope="col">Amazon</th>
                                <th scope="col">Rakuten</th>
                                <th scope="col">Surugaya</th>
                            </tr>
                        </thead>
                        <tbody id="sleeves-table-body">
                            <!-- Product rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="text-center mt-5 text-muted">
            <p>Generated from sleeves.json. Ownership and price data are saved in your browser.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('sleeves-table-body');
            const filterButtonGroup = document.querySelector('.btn-group');
            const vendors = ['mercari', 'amazon', 'rakuten', 'surugaya'];

            // --- Formatting and Utility Functions ---
            const toHalfWidth = (str) => str.replace(/[！-～]/g, r => String.fromCharCode(r.charCodeAt(0) - 0xFEE0));
            const cleanToNumber = (str) => toHalfWidth(str).replace(/[^0-9]/g, '');
            const formatNumber = (numStr) => {
                const num = parseInt(numStr, 10);
                return isNaN(num) ? '' : num.toLocaleString('ja-JP');
            };

            const updateRowAppearance = (row, button, isOwned) => {
                if (isOwned) {
                    button.textContent = 'Owned';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-success');
                    row.classList.add('table-success');
                } else {
                    button.textContent = 'Not Owned';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-secondary');
                    row.classList.remove('table-success');
                }
            };

            // --- Price Highlighting Functions ---
            const updatePriceHighlighting = (sleeveId) => {
                const row = tableBody.querySelector(`tr[data-sleeve-id="${sleeveId}"]`);
                if (!row) return;

                const priceInputs = row.querySelectorAll('input.price-input');
                const prices = [];

                // Collect all prices for this sleeve
                priceInputs.forEach(input => {
                    const cleanValue = cleanToNumber(input.value);
                    const numValue = parseInt(cleanValue, 10);

                    // Remove all highlighting classes first
                    input.classList.remove('has-value', 'lowest-price');

                    if (cleanValue && !isNaN(numValue) && numValue > 0) {
                        prices.push({ input, value: numValue });
                    }
                });

                // Apply highlighting
                if (prices.length > 0) {
                    // Find the lowest price
                    const lowestPrice = Math.min(...prices.map(p => p.value));

                    prices.forEach(({ input, value }) => {
                        if (value === lowestPrice) {
                            input.classList.add('lowest-price');
                        } else {
                            input.classList.add('has-value');
                        }
                    });
                }
            };

            const updateAllPriceHighlighting = () => {
                const rows = tableBody.querySelectorAll('tr[data-sleeve-id]');
                rows.forEach(row => {
                    const sleeveId = row.dataset.sleeveId;
                    updatePriceHighlighting(sleeveId);
                });
            };

            // --- Main Data Loading and Rendering ---
            fetch('sleeves.json')
                .then(response => response.json())
                .then(data => {
                    if (!tableBody) return;
                    tableBody.innerHTML = '';

                    data.forEach(sleeve => {
                        const row = document.createElement('tr');
                        row.dataset.sleeveId = sleeve.id;
                        const ownedStorageKey = `sleeve_owned_${sleeve.id}`;
                        const isOwned = localStorage.getItem(ownedStorageKey) === 'true';

                        // Image, Name, Owned Status cells (as before)
                        const imgCell = document.createElement('td');
                        if (sleeve.image_url) {
                            const img = document.createElement('img');
                            img.src = sleeve.image_url;
                            img.alt = sleeve.product_name;
                            img.className = 'product-image';
                            img.loading = 'lazy';
                            imgCell.appendChild(img);
                        }
                        row.appendChild(imgCell);

                        const nameCell = document.createElement('td');
                        nameCell.textContent = sleeve.product_name;
                        row.appendChild(nameCell);

                        const ownedCell = document.createElement('td');
                        const ownedButton = document.createElement('button');
                        ownedButton.className = 'btn btn-sm btn-owned-toggle';
                        ownedButton.dataset.id = sleeve.id;
                        ownedCell.appendChild(ownedButton);
                        row.appendChild(ownedCell);
                        
                        updateRowAppearance(row, ownedButton, isOwned);

                        // Price input cells
                        vendors.forEach(vendor => {
                            const priceCell = document.createElement('td');
                            const wrapper = document.createElement('div');
                            wrapper.className = 'price-cell-wrapper';

                            const priceInput = document.createElement('input');
                            priceInput.type = 'text'; // Use text to allow formatted display
                            priceInput.inputMode = 'numeric'; // Hint for mobile keyboards
                            priceInput.className = 'form-control form-control-sm price-input';
                            priceInput.dataset.id = sleeve.id;
                            priceInput.dataset.vendor = vendor;
                            
                            const priceStorageKey = `sleeve_price_${vendor}_${sleeve.id}`;
                            const savedValue = localStorage.getItem(priceStorageKey) || '';
                            priceInput.value = formatNumber(savedValue); // Display formatted on load

                            const yenLabel = document.createElement('span');
                            yenLabel.textContent = '円';
                            
                            wrapper.appendChild(priceInput);
                            wrapper.appendChild(yenLabel);
                            priceCell.appendChild(wrapper);
                            row.appendChild(priceCell);
                        });

                        tableBody.appendChild(row);
                    });

                    // Apply initial price highlighting after all rows are loaded
                    updateAllPriceHighlighting();
                })
                .catch(error => {
                    console.error('Error fetching or parsing sleeves.json:', error);
                    if(tableBody) {
                        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error loading data.</td></tr>`;
                    }
                });

            // --- Event Listeners ---

            // Ownership toggle
            tableBody.addEventListener('click', function(e) {
                if (e.target && e.target.matches('button.btn-owned-toggle')) {
                    const button = e.target;
                    const sleeveId = button.dataset.id;
                    const storageKey = `sleeve_owned_${sleeveId}`;
                    const row = button.closest('tr');
                    
                    let isOwned = localStorage.getItem(storageKey) === 'true';
                    isOwned = !isOwned;
                    localStorage.setItem(storageKey, isOwned);
                    
                    updateRowAppearance(row, button, isOwned);
                }
            });

            // Show raw number on focus for price inputs
            tableBody.addEventListener('focus', function(e) {
                if (e.target && e.target.matches('input.price-input')) {
                    const input = e.target;
                    input.value = cleanToNumber(input.value);
                }
            }, true);

            // Format and save on blur for price inputs
            tableBody.addEventListener('blur', function(e) {
                if (e.target && e.target.matches('input.price-input')) {
                    const input = e.target;
                    const cleanValue = cleanToNumber(input.value);

                    const sleeveId = input.dataset.id;
                    const vendor = input.dataset.vendor;
                    const storageKey = `sleeve_price_${vendor}_${sleeveId}`;

                    localStorage.setItem(storageKey, cleanValue);
                    input.value = formatNumber(cleanValue); // Re-format for display

                    // Update price highlighting for this row
                    updatePriceHighlighting(sleeveId);
                }
            }, true);

            // Filter buttons
            filterButtonGroup.addEventListener('click', function(e) {
                if (e.target && e.target.matches('button')) {
                    filterButtonGroup.querySelector('.active').classList.remove('active');
e.target.classList.add('active');

                    const filter = e.target.dataset.filter;
                    const rows = tableBody.querySelectorAll('tr');

                    rows.forEach(row => {
                        const isOwned = row.classList.contains('table-success');
                        let show = false;
                        if (filter === 'all') {
                            show = true;
                        }
                        else if (filter === 'owned' && isOwned) {
                            show = true;
                        }
                        else if (filter === 'not-owned' && !isOwned) {
                            show = true;
                        }
                        row.style.display = show ? '' : 'none';
                    });
                }
            });

            // --- Export/Import Functionality ---

            // Export data button
            document.getElementById('export-data-btn').addEventListener('click', function() {
                const exportData = {
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    data: {}
                };

                // Collect all localStorage data with sleeve_ prefix
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('sleeve_')) {
                        exportData.data[key] = localStorage.getItem(key);
                    }
                }

                // Create and download JSON file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `domina-sleeves-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                alert(`Data exported successfully!\nTotal items: ${Object.keys(exportData.data).length}`);
            });

            // Import data button
            document.getElementById('import-data-btn').addEventListener('click', function() {
                document.getElementById('import-file-input').click();
            });

            // File input handler
            document.getElementById('import-file-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importData = JSON.parse(event.target.result);

                        // Validate import data structure
                        if (!importData.data || typeof importData.data !== 'object') {
                            throw new Error('Invalid data format');
                        }

                        // Confirm before overwriting
                        const itemCount = Object.keys(importData.data).length;
                        const confirmed = confirm(
                            `Import ${itemCount} items?\n\n` +
                            `This will overwrite existing data.\n` +
                            `Export Date: ${importData.exportDate || 'Unknown'}\n` +
                            `Version: ${importData.version || 'Unknown'}\n\n` +
                            `Continue?`
                        );

                        if (!confirmed) {
                            e.target.value = ''; // Reset file input
                            return;
                        }

                        // Import data to localStorage
                        let importCount = 0;
                        for (const [key, value] of Object.entries(importData.data)) {
                            if (key.startsWith('sleeve_')) {
                                localStorage.setItem(key, value);
                                importCount++;
                            }
                        }

                        alert(`Import successful!\n${importCount} items imported.`);

                        // Reload page to reflect imported data
                        location.reload();
                    } catch (error) {
                        alert(`Import failed: ${error.message}\n\nPlease check the file format.`);
                    }

                    e.target.value = ''; // Reset file input
                };

                reader.onerror = function() {
                    alert('Failed to read file.');
                    e.target.value = ''; // Reset file input
                };

                reader.readAsText(file);
            });
        });
    </script>

</body>
</html>
